# 细胞毒实验排班系统

## 项目简介

细胞毒实验排班系统是一个基于Streamlit的可视化交互排班工具，专门为细胞毒实验设计。系统能够根据不同的检测方法自动计算实验步骤和日期，提供日历视图、周视图和每日汇总等功能，并支持企业微信通知提醒。系统还具备智能数据归档和查询功能，确保实验数据的完整性和可追溯性。

## 主要功能

### 1. 实验管理
- 支持5种细胞毒检测方法
- 自动计算实验步骤和日期
- 样品批号和备注管理
- 实验数据的增删改查
- 实验序号聚合显示，便于管理

### 2. 检测方法支持
- **7天计数增值度法**: 9天完成，包含上样、换液、计数等步骤
- **USP显微镜法**: 4天完成，包含上样、换液、观察等步骤
- **MTT-GB14233.2**: 5天完成，包含上样、换液、MTT结果观察
- **MTT-ISO等同16886**: 3天完成，包含上样、换液、MTT结果观察
- **日本药局方**: 11天完成，包含上样、换液、计数（9-11天选择）

### 3. 可视化界面
- **日历视图**: 月历显示，支持工作日/非工作日区分
- **周视图**: 周计划视图，显示每日实验安排
- **每日汇总**: 表格形式汇总每日实验内容
- **最近实验**: 显示从今天开始1个月内的实验，按序号聚合
- **中国节假日支持**: 使用chinesecalendar库自动识别工作日

### 4. 通知系统
- 企业微信webhook集成
- 定时提醒功能
- 手动通知发送
- 可配置提醒时间

### 5. 数据管理
- JSON格式数据存储
- Excel导出功能
- CSV下载支持
- 数据持久化
- **智能数据归档**: 自动归档过期实验数据（默认180天）
- **归档数据查询**: 支持查询已归档的历史实验数据

### 6. 高级查询功能
- **智能归档搜索**: 系统自动判断是否需要搜索归档数据
- **强制归档搜索**: 用户可手动控制是否搜索归档数据
- **多条件筛选**: 支持实验序号、日期范围、检测方法、样品批号、备注等条件
- **状态筛选**: 按实验状态（进行中、已完成、即将开始）筛选
- **聚合显示**: 按实验序号聚合显示，避免重复信息

## 技术架构

### 后端技术
- **Python 3.11+**: 核心编程语言
- **Streamlit**: Web应用框架
- **Pandas**: 数据处理和分析
- **chinesecalendar**: 中国节假日支持

### 项目结构
```
allergy-cytotoxic/
├── app.py                 # 主应用程序
├── config/               # 配置模块
│   ├── __init__.py
│   ├── settings.py      # 配置和检测方法定义
│   └── user_settings.json # 用户配置（通知、显示等）
├── utils/               # 工具模块
│   ├── __init__.py
│   ├── calendar_utils.py    # 日历工具
│   ├── schedule_utils.py    # 排班工具
│   ├── notification.py      # 通知功能
│   ├── scheduler.py         # 调度器
│   └── data_archive.py     # 数据归档管理
├── data/                # 数据存储目录
│   ├── experiments.json     # 活跃实验数据
│   └── archive/            # 归档数据目录
├── pyproject.toml       # 项目配置
├── requirements.txt     # 依赖包列表
├── start.json           # PM2配置文件
├── pm2_start.sh         # PM2启动脚本
├── start.sh             # 完整部署脚本
├── deploy.sh            # 一键部署脚本
├── quick_start.sh       # 快速启动脚本
└── README.md           # 项目说明
```

## 安装和运行

### 环境要求
- Python 3.11+
- uv包管理器

### 本地开发运行

1. **克隆项目**
```bash
git clone <repository-url>
cd allergy-cytotoxic
```

2. **安装依赖**
```bash
uv sync
```

3. **运行应用**
```bash
uv run streamlit run app.py
```

4. **访问应用**
打开浏览器访问: http://localhost:8501

### PM2生产环境部署

#### 一键部署（推荐）
```bash
# 给脚本添加执行权限
chmod +x *.sh

# 一键部署（包含环境检查、安装、配置、启动）
./deploy.sh
```

#### 分步部署
```bash
# 1. 环境配置和PM2启动
./start.sh

# 2. 或者只启动应用（需要先配置好环境）
./pm2_start.sh
```

#### PM2管理命令
```bash
# 查看状态
pm2 status

# 查看日志
pm2 logs allergy-cytotoxic

# 重启应用
pm2 restart allergy-cytotoxic

# 停止应用
pm2 stop allergy-cytotoxic

# 删除应用
pm2 delete allergy-cytotoxic
```

#### 部署后访问
- **本地访问**: http://localhost:8501
- **局域网访问**: http://[服务器IP]:8501

## 使用说明

### 1. 添加实验
1. 在"实验管理"页面选择"添加新实验"
2. 输入上样日期、选择检测方法
3. 填写样品批号和备注信息
4. 点击"添加实验"完成

### 2. 查看排班
- **日历视图**: 查看月度实验安排
- **周视图**: 查看周计划
- **每日汇总**: 查看每日实验列表
- **最近实验**: 查看从今天开始1个月内的实验安排

### 3. 配置通知
1. 在"通知设置"页面配置企业微信webhook
2. 设置推送时间和提醒天数
3. 启动调度器启用自动提醒

### 4. 数据导出
- 支持Excel格式导出（包含详细步骤和每日汇总）
- 支持CSV格式下载
- 数据自动保存到本地

### 5. 高级查询
1. 在"实验查询"页面设置查询条件
2. 选择是否包含归档数据
3. 使用强制搜索归档数据选项确保不遗漏历史数据
4. 系统会智能判断是否需要搜索归档数据

## 配置说明

### 企业微信配置
1. 在企业微信群中添加机器人
2. 获取webhook地址
3. 在系统中配置webhook地址
4. 测试连接确保配置正确

### 检测方法配置
检测方法在`config/settings.py`中定义，可以自定义添加新的检测方法：

```python
CYTOTOXIC_METHODS = {
    "新方法名称": {
        "name": "新方法名称",
        "steps": [
            {"day": 1, "action": "上样", "description": "第一天上样"},
            # 添加更多步骤...
        ]
    }
}
```

### 归档配置
- **归档阈值**: 默认180天，可在`utils/data_archive.py`中调整
- **归档策略**: 自动归档过期实验，支持手动归档
- **归档查询**: 智能触发归档搜索，支持强制搜索

## 扩展功能

### 预留接口
系统为以下功能预留了接口：
- 细胞毒照片整理数据库功能
- 更多检测方法支持
- 实验数据统计分析
- 多用户权限管理

## 注意事项

1. **日期格式**: 系统使用YYYY-MM-DD格式
2. **工作日调整**: 系统会自动将周末和节假日的实验调整到下一个工作日
3. **数据备份**: 建议定期备份`data/experiments.json`文件
4. **通知测试**: 首次配置webhook后请先测试连接
5. **归档数据**: 系统会自动归档过期数据，确保查询完整性

## 故障排除

### 常见问题

1. **chinesecalendar库导入失败**
   - 确保已正确安装: `uv add chinesecalendar`
   - 检查Python版本兼容性

2. **通知发送失败**
   - 检查webhook地址格式
   - 确认企业微信机器人权限
   - 检查网络连接

3. **日历显示异常**
   - 检查日期格式是否正确
   - 确认chinesecalendar库版本

4. **归档数据查询不到**
   - 检查是否勾选"包含归档数据"
   - 使用"强制搜索归档数据"选项
   - 确认查询条件是否合理

5. **PM2部署失败**
   - 检查脚本执行权限: `chmod +x *.sh`
   - 确认系统环境: Python 3.11+, Node.js, PM2
   - 查看PM2日志: `pm2 logs allergy-cytotoxic`
   - 检查端口占用: `sudo netstat -tlnp | grep 8501`

## 更新日志

### v1.0.0 (2025-01-14)
- 初始版本发布
- 支持5种细胞毒检测方法
- 实现基础排班功能
- 集成企业微信通知
- 支持日历和周视图

### v1.1.0 (2025-01-14)
- 新增智能数据归档功能
- 优化归档数据查询逻辑
- 改进最近实验展示（按序号聚合）
- 增强查询筛选功能
- 支持强制搜索归档数据

### v1.2.0 (2025-01-14)
- 新增PM2生产环境部署支持
- 提供一键部署脚本
- 支持自动环境检查和依赖安装
- 集成PM2进程管理和监控
- 支持开机自启和日志管理

## 贡献指南

欢迎提交Issue和Pull Request来改进系统功能。

## 许可证

本项目采用MIT许可证。

## 联系方式

如有问题或建议，请通过以下方式联系：
- 提交GitHub Issue
- 发送邮件至: [your-email@example.com]

---

**注意**: 本系统仅供实验室内部使用，请勿用于商业用途。
